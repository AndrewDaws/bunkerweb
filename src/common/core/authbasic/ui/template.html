{% extends "base.html" %} {% block content %}

<div class="col-span-12 grid grid-cols-12 gap-4">
  <!-- info-->
  <div
    class="h-fit transition hover:scale-102 col-span-12 md:col-span-6 2xl:col-span-4 3xl:col-span-3 p-4 relative min-w-0 break-words bg-white shadow-xl dark:bg-slate-850 dark:shadow-dark-xl rounded-2xl bg-clip-border"
  >
    <h5 class="mb-2 font-bold dark:text-white/90">INFO</h5>

    <div class="mx-1 flex justify-start items-center my-4">
      <p
        data-info
        class="transition duration-300 ease-in-out mb-0 font-sans text-sm leading-normal dark:text-gray-500 dark:opacity-80"
      ></p>
    </div>
  </div>
  <!-- end info -->

  <div
    class="h-fit dark:brightness-110 max-h-none sm:max-h-28 hover:scale-102 transition col-span-12 md:col-span-6 2xl:col-span-4 flex p-4 justify-between w-full shadow-md break-words bg-white dark:bg-slate-850 dark:shadow-dark-xl rounded-2xl bg-clip-border"
  >
    <!-- text -->
    <div>
      <p
        class="mb-2 font-sans text-sm font-semibold leading-normal uppercase dark:text-white dark:opacity-60"
      >
        AUTH BASIC
      </p>
      <h5 data-count class="mb-1 font-bold dark:text-white/90"></h5>

      <p class="mb-0 dark:text-white dark:opacity-60">
        <span class="font-bold leading-normal text-sm text-green-500 mx-0.5"
          >passed credentials</span
        >
      </p>
    </div>
    <!-- end text -->
    <!-- icon -->
    <div
      role="img"
      class="dark:brightness-90 inline-block w-12 h-12 text-center rounded-circle bg-green-500"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        viewBox="0 0 24 24"
        fill="currentColor"
        class="stroke-none scale-[0.6] leading-none text-lg relative fill-white"
      >
        <path
          fill-rule="evenodd"
          d="M15.75 1.5a6.75 6.75 0 0 0-6.651 7.906c.067.39-.032.717-.221.906l-6.5 6.499a3 3 0 0 0-.878 2.121v2.818c0 .414.336.75.75.75H6a.75.75 0 0 0 .75-.75v-1.5h1.5A.75.75 0 0 0 9 19.5V18h1.5a.75.75 0 0 0 .53-.22l2.658-2.658c.19-.189.517-.288.906-.22A6.75 6.75 0 1 0 15.75 1.5Zm0 3a.75.75 0 0 0 0 1.5A2.25 2.25 0 0 1 18 8.25a.75.75 0 0 0 1.5 0 3.75 3.75 0 0 0-3.75-3.75Z"
          clip-rule="evenodd"
        />
      </svg>
    </div>
    <!-- end icon -->
  </div>

  <div
    role="alert"
    data-fetch
    class="bg-sky-500 p-4 mb-1 md:mb-3 md:mr-3 z-[1001] flex flex-col fixed bottom-0 right-0 w-full md:w-1/2 max-w-[300px] min-h-20 rounded-lg dark:brightness-110 hover:scale-102 transition shadow-md break-words dark:bg-slate-850 dark:shadow-dark-xl bg-clip-border"
  >
    <button data-fetch-close class="absolute right-7 top-1.5">
      <svg
        class="cursor-pointer fill-white dark:fill-gray-300 dark:opacity-80 absolute h-5 w-5"
        xmlns="http://www.w3.org/2000/svg"
        viewBox="0 0 320 512"
      >
        <path
          d="M310.6 150.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L160 210.7 54.6 105.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3L114.7 256 9.4 361.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0L160 301.3 265.4 406.6c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L205.3 256 310.6 150.6z"
        ></path>
      </svg>
    </button>
    <h5 data-fetch-status class="text-lg mb-0 text-white dark:text-gray-300">
      Fetching
    </h5>
    <p data-fetch-msg class="text-white dark:text-gray-300 mb-0 text-sm">
      Please wait...
    </p>
  </div>

  <script>
    class SetupPlugin {
      constructor() {
        // Alert elements
        this.alertEl = document.querySelector("[data-fetch]");
        this.alertCloseEl = document.querySelector("[data-fetch-close]");
        this.alertStatusEl = document.querySelector("[data-fetch-status]");
        this.alertMsgEl = document.querySelector("[data-fetch-msg]");
        // Set data defaults elements and variables
        // Key of this.data need to match key of fetch data json object to update values
        // type<str> : text (target el), list (el need to be first element of list)
        // listNames<arr> : list of names key on item, need to set data-name="nameKey" on el
        this.data = {
          info: {
            el: document.querySelector("[data-info]"),
            value: `Basic Auth is a method for an HTTP user agent
        (e.g. a web browser) to provide a user name and password when making a
        request.`,
            type: "text",
          },
          count: {
            el: document.querySelector("[data-count]"),
            value: `unknown`,
            type: "text",
          },
          /* EXAMPLE
          // value : active / inactive / unknown
          status: {
            el: document.querySelector("[data-status]"),
            value: "unknown",
            type: "status",
            textEl: document.querySelector("[data-status-text]"),
          },
          */
        };
        // Hidden elements that will be shown on success, like ping buttons or list rendering
        this.showOnSuccessEls = document.querySelectorAll(
          "[data-fetch-success-show]",
        );

        this.init();
      }

      init() {
        window.addEventListener("DOMContentLoaded", () => {
          // Set default values and fetch
          this.updateDataDOM();
          this.updateAlert("fetch");

          fetch(location.href, {
            method: "POST",
            headers: {
              "X-CSRFToken": "{{ csrf_token() }}",
            },
          })
            .then((res) => res.json())
            .then((res) => {
              // Update data and DOM
              this.getFetchDataByKey(res.data.data);
              this.updateDataDOM();
              // Show hidden elements
              this.showSuccessEls();
              // Feedback
              this.updateAlert("success");
            })
            .catch((error) => {
              this.updateAlert("error");
            });
        });

        this.alertCloseEl.addEventListener("click", () => {
          this.alertEl.classList.add("hidden");
        });
      }

      showSuccessEls() {
        this.showOnSuccessEls.forEach((el) => {
          el.classList.remove("hidden");
        });
      }

      // Key of fetch data need to match key of this.data
      getFetchDataByKey(fetchDataObj) {
        for (const [key, value] of Object.entries(this.data)) {
          value["value"] = fetchDataObj[key] || value["value"] || "";
        }
      }

      updateDataDOM() {
        for (const [key, val] of Object.entries(this.data)) {
          const el = val["el"];
          const type = val["type"];
          const value = val["value"];

          // Case text
          if (type === "text") {
            el.textContent = value || "";
            continue;
          }
          // Case status
          if (type === "status") {
            const textEl = val["textEl"] || null;

            if (value === "active")
              this.setStatus(el, textEl, "fill-green-500", "Active");
            if (value === "inactive")
              this.setStatus(el, textEl, "fill-red-500", "Inactive");
            if (value === "unknown")
              this.setStatus(el, textEl, "fill-sky-500", "Unknown");
            continue;
          }

          // Case list, we will render elements after the selected elements
          if (type === "list") {
            // Case no list to render
            if (!value || value.length <= 0) continue;

            // Clone item element
            const itemEl = el.cloneNode(true);
            itemEl.classList.remove("hidden");
            const parentEl = el.parentNode;
            // Add item element after selected element
            const items = value.forEach((item) => {
              const newItemEl = itemEl.cloneNode(true);
              // Update item element values
              for (const [nameKey, nameValue] of Object.entries(item)) {
                newItemEl.querySelector(
                  `[data-name="${nameKey}"]`,
                ).textContent = nameValue;
              }
              // Add item element after selected element
              parentEl.appendChild(newItemEl);
            });

            // Delete schema
            el.remove();
            continue;
          }
        }
      }

      setStatus(el, textEl, colorClass, text) {
        el.classList.remove("fill-green-500", "fill-red-500", "fill-sky-500");
        el ? el.classList.add(colorClass) : null;
        textEl ? (textEl.textContent = text) : null;
      }

      // Show fetch state alert
      // type<str> : fetch, success, error
      updateAlert(type) {
        if (!type) return;

        const [status, msg, color] = this.getAlertType(type);

        this.alertEl.classList.remove(
          "bg-sky-500",
          "bg-green-500",
          "bg-red-500",
        );

        this.alertStatusEl.textContent = status;
        this.alertMsgEl.textContent = msg;
        this.alertEl.classList.add(color);

        this.alertEl.classList.remove("hidden");

        if (type !== "fetch")
          setTimeout(() => this.alertEl.classList.add("hidden"), 5000);
      }

      getAlertType(type) {
        if (type === "fetch")
          return ["Fetching", "Please wait...", "bg-sky-500"];
        if (type === "error")
          return ["Error", "Something went wrong", "bg-red-500"];
        if (type === "success")
          return ["Success", "Data fetched successfully", "bg-green-500"];
      }
    }

    new SetupPlugin();
  </script>
</div>

{% endblock %}
