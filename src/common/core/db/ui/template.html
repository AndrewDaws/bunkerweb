{% extends "base.html" %} {% block content %}

<div class="col-span-12 grid grid-cols-12 gap-4">
  <!-- info-->
  <div class="col-span-12 grid grid-cols-12 gap-4">
    <div
      class="h-fit transition hover:scale-102 col-span-12 md:col-span-6 2xl:col-span-4 3xl:col-span-3 p-4 relative min-w-0 break-words bg-white shadow-xl dark:bg-slate-850 dark:shadow-dark-xl rounded-2xl bg-clip-border"
    >
      <h5 class="mb-2 font-bold dark:text-white/90">INFO</h5>

      <div class="mx-1 flex justify-start items-center my-4">
        <p
          data-info
          class="transition duration-300 ease-in-out mb-0 font-sans text-sm leading-normal dark:text-gray-500 dark:opacity-80"
        ></p>
      </div>
    </div>
  </div>
  <!-- end info -->

  <!-- driver-->
  <div
    class="h-fit transition hover:scale-102 col-span-12 md:col-span-6 2xl:col-span-4 3xl:col-span-3 p-4 relative min-w-0 break-words bg-white shadow-xl dark:bg-slate-850 dark:shadow-dark-xl rounded-2xl bg-clip-border"
  >
    <h5 class="mb-2 font-bold dark:text-white/90">DB</h5>

    <div class="mx-1 flex justify-start items-center mt-4">
      <p
        class="transition duration-300 ease-in-out font-bold mb-0 font-sans text-sm leading-normal uppercase dark:text-gray-500 dark:opacity-80"
      >
        DRIVER
        <span
          data-driver
          class="ml-1 font-semibold transition duration-300 ease-in-out mb-0 font-sans text-sm leading-normal dark:text-gray-500 dark:opacity-80"
        >
        </span>
      </p>
    </div>
    <div class="mx-1 flex justify-start items-center mt-1 mb-4">
      <p
        class="transition duration-300 ease-in-out font-bold mb-0 font-sans text-sm leading-normal uppercase dark:text-gray-500 dark:opacity-80"
      >
        VERSION
        <span
          data-version
          class="ml-1 font-semibold transition duration-300 ease-in-out mb-0 font-sans text-sm leading-normal dark:text-gray-500 dark:opacity-80"
        >
        </span>
      </p>
    </div>
  </div>
  <!-- end driver -->

  <div
    class="h-fit dark:brightness-110 max-h-none sm:max-h-28 hover:scale-102 transition col-span-12 md:col-span-6 2xl:col-span-4 flex p-4 justify-between w-full shadow-md break-words bg-white dark:bg-slate-850 dark:shadow-dark-xl rounded-2xl bg-clip-border"
  >
    <!-- text -->
    <div>
      <p
        class="mb-2 font-sans text-sm font-semibold leading-normal uppercase dark:text-white dark:opacity-60"
      >
        SIZE
      </p>
      <h5 data-size class="mb-1 font-bold dark:text-white/90"></h5>

      <p class="mb-0 dark:text-white dark:opacity-60">
        <span class="font-bold leading-normal text-sm text-sky-500 mx-0.5">
          MB used on database
        </span>
      </p>
    </div>
    <!-- end text -->
    <!-- icon -->
    <div
      role="img"
      class="dark:brightness-90 inline-block w-12 h-12 text-center rounded-circle bg-sky-700"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        viewBox="0 0 24 24"
        fill="currentColor"
        class="scale-[0.6] leading-none text-lg relative fill-white"
      >
        <path
          d="M21 6.375c0 2.692-4.03 4.875-9 4.875S3 9.067 3 6.375 7.03 1.5 12 1.5s9 2.183 9 4.875Z"
        />
        <path
          d="M12 12.75c2.685 0 5.19-.586 7.078-1.609a8.283 8.283 0 0 0 1.897-1.384c.016.121.025.244.025.368C21 12.817 16.97 15 12 15s-9-2.183-9-4.875c0-.124.009-.247.025-.368a8.285 8.285 0 0 0 1.897 1.384C6.809 12.164 9.315 12.75 12 12.75Z"
        />
        <path
          d="M12 16.5c2.685 0 5.19-.586 7.078-1.609a8.282 8.282 0 0 0 1.897-1.384c.016.121.025.244.025.368 0 2.692-4.03 4.875-9 4.875s-9-2.183-9-4.875c0-.124.009-.247.025-.368a8.284 8.284 0 0 0 1.897 1.384C6.809 15.914 9.315 16.5 12 16.5Z"
        />
        <path
          d="M12 20.25c2.685 0 5.19-.586 7.078-1.609a8.282 8.282 0 0 0 1.897-1.384c.016.121.025.244.025.368 0 2.692-4.03 4.875-9 4.875s-9-2.183-9-4.875c0-.124.009-.247.025-.368a8.284 8.284 0 0 0 1.897 1.384C6.809 19.664 9.315 20.25 12 20.25Z"
        />
      </svg>
    </div>
    <!-- end icon -->
  </div>
  <div
    role="alert"
    data-fetch
    class="bg-sky-500 p-4 mb-1 md:mb-3 md:mr-3 z-[1001] flex flex-col fixed bottom-0 right-0 w-full md:w-1/2 max-w-[300px] min-h-20 rounded-lg dark:brightness-110 hover:scale-102 transition shadow-md break-words dark:bg-slate-850 dark:shadow-dark-xl bg-clip-border"
  >
    <button data-fetch-close class="absolute right-7 top-1.5">
      <svg
        class="cursor-pointer fill-white dark:fill-gray-300 dark:opacity-80 absolute h-5 w-5"
        xmlns="http://www.w3.org/2000/svg"
        viewBox="0 0 320 512"
      >
        <path
          d="M310.6 150.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L160 210.7 54.6 105.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3L114.7 256 9.4 361.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0L160 301.3 265.4 406.6c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L205.3 256 310.6 150.6z"
        ></path>
      </svg>
    </button>
    <h5 data-fetch-status class="text-lg mb-0 text-white dark:text-gray-300">
      Fetching
    </h5>
    <p data-fetch-msg class="text-white dark:text-gray-300 mb-0 text-sm">
      Please wait...
    </p>
  </div>

  <script>
    class SetupPlugin {
      constructor() {
        // Alert elements
        this.alertEl = document.querySelector("[data-fetch]");
        this.alertCloseEl = document.querySelector("[data-fetch-close]");
        this.alertStatusEl = document.querySelector("[data-fetch-status]");
        this.alertMsgEl = document.querySelector("[data-fetch-msg]");
        // Set data defaults elements and variables
        // Key of this.data need to match key of fetch data json object to update values
        // type<str> : text (target el), list (el need to be first element of list)
        // listNames<arr> : list of names key on item, need to set data-name="nameKey" on el
        this.data = {
          info: {
            el: document.querySelector("[data-info]"),
            value: `BunkerWeb securely stores its current configuration in
          a backend database, which contains essential data for smooth
          operation.`,
            type: "text",
          },
          driver: {
            el: document.querySelector("[data-driver]"),
            value: "",
            type: "text",
          },
          version: {
            el: document.querySelector("[data-version]"),
            value: "",
            type: "text",
          },
          size: {
            el: document.querySelector("[data-size]"),
            value: "",
            type: "text",
          },
          /* EXAMPLE
          items: {
            el: document.querySelector("[data-item]"),
            value: [],
            type: "list",
            listNames: ["server_name", "cn", "expire"],
          },
          // value : active / inactive / unknown
          status: {
            el: document.querySelector("[data-status]"),
            value: "unknown",
            type: "status",
            textEl: document.querySelector("[data-status-text]"),
          },
          */
        };
        // Hidden elements that will be shown on success, like ping buttons or list rendering
        this.showOnSuccessEls = document.querySelectorAll(
          "[data-fetch-success-show]",
        );

        this.init();
      }

      init() {
        window.addEventListener("DOMContentLoaded", () => {
          // Set default values and fetch
          this.updateDataDOM();
          this.updateAlert("fetch");

          fetch(location.href, {
            method: "POST",
            headers: {
              "X-CSRFToken": "{{ csrf_token() }}",
            },
          })
            .then((res) => res.json())
            .then((res) => {
              // Update data and DOM
              this.getFetchDataByKey(res.data.data);
              this.updateDataDOM();
              // Show hidden elements
              this.showSuccessEls();
              // Feedback
              this.updateAlert("success");
            })
            .catch((error) => {
              this.updateAlert("error");
            });
        });

        this.alertCloseEl.addEventListener("click", () => {
          this.alertEl.classList.add("hidden");
        });
      }

      showSuccessEls() {
        this.showOnSuccessEls.forEach((el) => {
          el.classList.remove("hidden");
        });
      }

      // Key of fetch data need to match key of this.data
      getFetchDataByKey(fetchDataObj) {
        for (const [key, value] of Object.entries(this.data)) {
          value["value"] = fetchDataObj[key] || value["value"] || "";
        }
      }

      updateDataDOM() {
        for (const [key, val] of Object.entries(this.data)) {
          const el = val["el"];
          const type = val["type"];
          const value = val["value"];

          // Case text
          if (type === "text") {
            el.textContent = value || "";
            continue;
          }
          // Case status
          if (type === "status") {
            const textEl = val["textEl"] || null;

            if (value === "active")
              this.setStatus(el, textEl, "fill-green-500", "Active");
            if (value === "inactive")
              this.setStatus(el, textEl, "fill-red-500", "Inactive");
            if (value === "unknown")
              this.setStatus(el, textEl, "fill-sky-500", "Unknown");
            continue;
          }

          // Case list, we will render elements after the selected elements
          if (type === "list") {
            // Case no list to render
            if (!value || value.length <= 0) continue;

            // Clone item element
            const itemEl = el.cloneNode(true);
            itemEl.classList.remove("hidden");
            const parentEl = el.parentNode;
            // Add item element after selected element
            const items = value.forEach((item) => {
              const newItemEl = itemEl.cloneNode(true);
              // Update item element values
              for (const [nameKey, nameValue] of Object.entries(item)) {
                newItemEl.querySelector(
                  `[data-name="${nameKey}"]`,
                ).textContent = nameValue;
              }
              // Add item element after selected element
              parentEl.appendChild(newItemEl);
            });

            // Delete schema
            el.remove();
            continue;
          }
        }
      }

      setStatus(el, textEl, colorClass, text) {
        el.classList.remove("fill-green-500", "fill-red-500", "fill-sky-500");
        el ? el.classList.add(colorClass) : null;
        textEl ? (textEl.textContent = text) : null;
      }

      // Show fetch state alert
      // type<str> : fetch, success, error
      updateAlert(type) {
        if (!type) return;

        const [status, msg, color] = this.getAlertType(type);

        this.alertEl.classList.remove(
          "bg-sky-500",
          "bg-green-500",
          "bg-red-500",
        );

        this.alertStatusEl.textContent = status;
        this.alertMsgEl.textContent = msg;
        this.alertEl.classList.add(color);

        this.alertEl.classList.remove("hidden");

        if (type !== "fetch")
          setTimeout(() => this.alertEl.classList.add("hidden"), 5000);
      }

      getAlertType(type) {
        if (type === "fetch")
          return ["Fetching", "Please wait...", "bg-sky-500"];
        if (type === "error")
          return ["Error", "Something went wrong", "bg-red-500"];
        if (type === "success")
          return ["Success", "Data fetched successfully", "bg-green-500"];
      }
    }

    new SetupPlugin();
  </script>
</div>
{% endblock %}
