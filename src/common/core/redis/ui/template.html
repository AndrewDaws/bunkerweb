{% extends "base.html" %} {% block content %}

<div class="col-span-12 grid grid-cols-12 gap-4">
  <!-- status -->
  <div class="col-span-12 grid grid-cols-12 gap-4">
    <div
      class="col-span-12 md:col-span-6 2xl:col-span-3 3xl:col-span-2 w-fit h-fit transition hover:scale-102 p-4 relative min-w-0 break-words bg-white shadow-xl dark:bg-slate-850 dark:shadow-dark-xl rounded-2xl bg-clip-border"
    >
      <div class="mx-1 flex justify-start items-center">
        <h5 class="mb-0 font-bold dark:text-white/90 mr-4">STATUS</h5>
        <svg
          data-status-svg
          class="w-8 h-8"
          viewBox="0 0 100 100"
          xmlns="http://www.w3.org/2000/svg"
        >
          <circle cx="50" cy="50" r="50" />
        </svg>
      </div>
      <p
        data-status-text
        class="mx-1 transition duration-300 ease-in-out mb-0 font-sans text-sm leading-normal dark:text-gray-500 dark:opacity-80"
      ></p>
    </div>
    <!-- end status -->
  </div>

  <!-- info-->
  <div
    class="h-fit transition hover:scale-102 col-span-12 md:col-span-6 2xl:col-span-4 3xl:col-span-3 p-4 relative min-w-0 break-words bg-white shadow-xl dark:bg-slate-850 dark:shadow-dark-xl rounded-2xl bg-clip-border"
  >
    <h5 class="mb-2 font-bold dark:text-white/90">INFO</h5>

    <div class="mx-1 flex justify-start items-center my-4">
      <p
        data-info
        class="transition duration-300 ease-in-out mb-0 font-sans text-sm leading-normal dark:text-gray-500 dark:opacity-80"
      ></p>
    </div>
  </div>
  <!-- end info -->

  <!-- test-->
  <div
    class="transition hover:scale-102 col-span-12 md:col-span-6 2xl:col-span-4 3xl:col-span-3 p-4 relative min-w-0 break-words bg-white shadow-xl dark:bg-slate-850 dark:shadow-dark-xl rounded-2xl bg-clip-border"
  >
    <h5 class="mb-2 font-bold dark:text-white/90">TEST</h5>
    <p
      class="my-2 transition duration-300 ease-in-out mb-0 font-sans text-sm leading-normal dark:text-gray-500 dark:opacity-80 text-center"
    >
      Use the next button to ping Redis.
    </p>

    <div class="flex justify-center mt-4">
      <button type="button" class="edit-btn text-sm" onclick="ping()">
        Ping Redis
      </button>
    </div>

    <hr
      class="h-px mx-0 mt-3 mb-2 bg-transparent bg-gradient-to-r from-transparent via-black/40 to-transparent dark:bg-gradient-to-r dark:from-transparent dark:via-white dark:to-transparent"
    />

    <div id="response-div" class="flex justify-center items-center">
      <div id="no-test" class="flex justify-center items-center">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
          stroke-width="1.5"
          stroke="currentColor"
          class="w-6 h-6 stroke-gray-600"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z"
          />
        </svg>
        <p class="mb-0 ml-1 font-semibold text-gray-600 text-base uppercase">
          UNKNOWN
        </p>
      </div>
      <div
        class="hidden flex justify-center items-center"
        id="response-success"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
          stroke-width="1.5"
          stroke="currentColor"
          class="w-6 h-6 stroke-green-500"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"
          />
        </svg>
        <p class="mb-0 ml-1 font-semibold text-green-500 text-base uppercase">
          SUCCESS
        </p>
      </div>
      <div class="hidden flex justify-center items-center" id="response-failed">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
          stroke-width="1.5"
          stroke="currentColor"
          class="w-6 h-6 stroke-red-500"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M12 9v3.75m9-.75a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 3.75h.008v.008H12v-.008Z"
          />
        </svg>
        <p class="mb-0 ml-1 font-semibold text-red-500 text-base uppercase">
          FAILED
        </p>
      </div>
      <div class="hidden flex justify-center items-center" id="response-none">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
          stroke-width="1.5"
          stroke="currentColor"
          class="w-6 h-6 stroke-red-500"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M18.364 18.364A9 9 0 0 0 5.636 5.636m12.728 12.728A9 9 0 0 1 5.636 5.636m12.728 12.728L5.636 5.636"
          />
        </svg>

        <p class="mb-0 ml-1 font-semibold text-red-500 text-base uppercase">
          FAILED
        </p>
      </div>
    </div>
  </div>
  <div
    role="alert"
    data-fetch
    class="bg-sky-500 p-4 mb-1 md:mb-3 md:mr-3 z-[1001] flex flex-col fixed bottom-0 right-0 w-full md:w-1/2 max-w-[300px] min-h-20 rounded-lg dark:brightness-110 hover:scale-102 transition shadow-md break-words dark:bg-slate-850 dark:shadow-dark-xl bg-clip-border"
  >
    <button data-fetch-close class="absolute right-7 top-1.5">
      <svg
        class="cursor-pointer fill-white dark:fill-gray-300 dark:opacity-80 absolute h-5 w-5"
        xmlns="http://www.w3.org/2000/svg"
        viewBox="0 0 320 512"
      >
        <path
          d="M310.6 150.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L160 210.7 54.6 105.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3L114.7 256 9.4 361.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0L160 301.3 265.4 406.6c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L205.3 256 310.6 150.6z"
        ></path>
      </svg>
    </button>
    <h5 data-fetch-status class="text-lg mb-0 text-white dark:text-gray-300">
      Fetching
    </h5>
    <p data-fetch-msg class="text-white dark:text-gray-300 mb-0 text-sm">
      Please wait...
    </p>
  </div>

  <script>
    class SetupPlugin {
      constructor() {
        // Alert elements
        this.alertEl = document.querySelector("[data-fetch]");
        this.alertCloseEl = document.querySelector("[data-fetch-close]");
        this.alertStatusEl = document.querySelector("[data-fetch-status]");
        this.alertMsgEl = document.querySelector("[data-fetch-msg]");
        // Set data defaults elements and variables
        // Key of this.data need to match key of fetch data json object to update values
        // type<str> : text (target el), list (el need to be first element of list)
        // listNames<arr> : list of names key on item, need to set data-name="nameKey" on el
        this.data = {
          info: {
            el: document.querySelector("[data-info]"),
            value: `Redis server configuration when using BunkerWeb in
        cluster mode.`,
            type: "text",
          },
          // value : active / inactive / unknown
          status: {
            el: document.querySelector("[data-status-svg]"),
            value: "unknown",
            type: "status",
            textEl: document.querySelector("[data-status-text]"),
          },
        };
        // Hidden elements that will be shown on success, like ping buttons or list rendering
        this.showOnSuccessEls = document.querySelectorAll(
          "[data-fetch-success-show]",
        );

        this.init();
      }

      init() {
        window.addEventListener("DOMContentLoaded", () => {
          // Set default values and fetch
          this.updateDataDOM();
          this.updateAlert("fetch");

          fetch(location.href, {
            method: "POST",
            headers: {
              "X-CSRFToken": "{{ csrf_token() }}",
            },
          })
            .then((res) => res.json())
            .then((res) => {
              // Update data and DOM
              this.getFetchDataByKey(res.data.data);
              this.updateDataDOM();
              // Show hidden elements
              this.showSuccessEls();
              // Feedback
              this.updateAlert("success");
            })
            .catch((error) => {
              this.updateAlert("error");
            });
        });

        this.alertCloseEl.addEventListener("click", () => {
          this.alertEl.classList.add("hidden");
        });
      }

      showSuccessEls() {
        this.showOnSuccessEls.forEach((el) => {
          el.classList.remove("hidden");
        });
      }

      // Key of fetch data need to match key of this.data
      getFetchDataByKey(fetchDataObj) {
        for (const [key, value] of Object.entries(this.data)) {
          value["value"] = fetchDataObj[key] || value["value"] || "";
        }
      }

      updateDataDOM() {
        for (const [key, val] of Object.entries(this.data)) {
          const el = val["el"];
          const type = val["type"];
          const value = val["value"];

          // Case text
          if (type === "text") {
            el.textContent = value || "";
            continue;
          }
          // Case status
          if (type === "status") {
            const textEl = val["textEl"] || null;

            if (value === "active")
              this.setStatus(el, textEl, "fill-green-500", "Active");
            if (value === "inactive")
              this.setStatus(el, textEl, "fill-red-500", "Inactive");
            if (value === "unknown")
              this.setStatus(el, textEl, "fill-sky-500", "Unknown");
            continue;
          }

          // Case list, we will render elements after the selected elements
          if (type === "list") {
            // Case no list to render
            if (!value || value.length <= 0) continue;

            // Clone item element
            const itemEl = el.cloneNode(true);
            itemEl.classList.remove("hidden");
            const parentEl = el.parentNode;
            // Add item element after selected element
            const items = value.forEach((item) => {
              const newItemEl = itemEl.cloneNode(true);
              // Update item element values
              for (const [nameKey, nameValue] of Object.entries(item)) {
                newItemEl.querySelector(
                  `[data-name="${nameKey}"]`,
                ).textContent = nameValue;
              }
              // Add item element after selected element
              parentEl.appendChild(newItemEl);
            });

            // Delete schema
            el.remove();
            continue;
          }
        }
      }

      setStatus(el, textEl, colorClass, text) {
        el.classList.remove("fill-green-500", "fill-red-500", "fill-sky-500");
        el ? el.classList.add(colorClass) : null;
        textEl ? (textEl.textContent = text) : null;
      }

      // Show fetch state alert
      // type<str> : fetch, success, error
      updateAlert(type) {
        if (!type) return;

        const [status, msg, color] = this.getAlertType(type);

        this.alertEl.classList.remove(
          "bg-sky-500",
          "bg-green-500",
          "bg-red-500",
        );

        this.alertStatusEl.textContent = status;
        this.alertMsgEl.textContent = msg;
        this.alertEl.classList.add(color);

        this.alertEl.classList.remove("hidden");

        if (type !== "fetch")
          setTimeout(() => this.alertEl.classList.add("hidden"), 5000);
      }

      getAlertType(type) {
        if (type === "fetch")
          return ["Fetching", "Please wait...", "bg-sky-500"];
        if (type === "error")
          return ["Error", "Something went wrong", "bg-red-500"];
        if (type === "success")
          return ["Success", "Data fetched successfully", "bg-green-500"];
      }
    }

    new SetupPlugin();
  </script>

  <script async>
    function ping() {
      let data = new FormData();
      data.set("csrf_token", "{{ csrf_token() }}");

      let xhr = new XMLHttpRequest();
      xhr.open("POST", "{{ url_for('plugins') }}/bunkernet", true);
      xhr.send(data);

      xhr.onload = function () {
        document.getElementById("no-test").classList.add("hidden");
        if (xhr.status == 200) {
          document.getElementById("response-failed").classList.remove("hidden");
          document.getElementById("response-none").classList.add("hidden");
          document.getElementById("response-success").classList.add("hidden");
        } else if (xhr.status == 403) {
          document
            .getElementById("response-success")
            .classList.remove("hidden");
          document.getElementById("response-none").classList.add("hidden");
          document.getElementById("response-failed").classList.add("hidden");
        } else {
          document.getElementById("response-none").classList.remove("hidden");
          document.getElementById("response-success").classList.add("hidden");
          document.getElementById("response-failed").classList.add("hidden");
        }
      };
    }
  </script>
</div>

{% endblock %}
