log_by_lua_block {

local class     	= require "middleclass"
local clogger		= require "bunkerweb.logger"
local helpers		= require "bunkerweb.helpers"
local cdatastore	= require "bunkerweb.datastore"
local cjson			= require "cjson"

-- Start log phase
local logger	= clogger:new("LOG")
local datastore	= cdatastore:new()
logger:log(ngx.INFO, "log phase started")

-- Fill ctx
logger:log(ngx.INFO, "filling ngx.ctx ...")
local ok, ret, errors = helpers.fill_ctx()
if not ok then
	logger:log(ngx.ERR, "fill_ctx() failed : " .. ret)
elseif errors then
	for i, error in ipairs(errors) do
		logger:log(ngx.ERR, "fill_ctx() error " .. tostring(i) .. " : " .. error)
	end
end
logger:log(ngx.INFO, "ngx.ctx filled (ret = " .. ret .. ")")

-- Get plugins order
local order, err = datastore:get("plugins_order")
if not order then
	logger:log(ngx.ERR, "can't get plugins order from datastore : " .. err)
	return
end
order = cjson.decode(order)

-- Call log_stream() methods
logger:log(ngx.INFO, "calling log_stream() methods of plugins ...")
for i, plugin_id in ipairs(order.log_stream) do
	-- Require call
	local plugin_lua, err = helpers.require_plugin(plugin_id)
	if plugin_lua == false then
		logger:log(ngx.ERR, err)
	elseif plugin_lua == nil then
		logger:log(ngx.INFO, err)
	else
		-- Check if plugin has log_stream method
		if plugin_lua.log_stream ~= nil then
			-- New call
			local ok, plugin_obj = helpers.new_plugin(plugin_lua)
			if not ok then
				logger:log(ngx.ERR, plugin_obj)
			else
				local ok, ret = helpers.call_plugin(plugin_obj, "log_stream")
				if not ok then
					logger:log(ngx.ERR, ret)
				elseif not ret.ret then
					logger:log(ngx.ERR, plugin_id .. ":log_stream() call failed : " .. ret.msg)
				else
					logger:log(ngx.INFO, plugin_id .. ":log_stream() call successful : " .. ret.msg)
				end
			end
		else
			logger:log(ngx.INFO, "skipped execution of " .. plugin_id .. " because method log_stream() is not defined")
		end
	end
end
logger:log(ngx.INFO, "called log_stream() methods of plugins")

-- Display reason at info level
if ngx.ctx.reason then
	logger:log(ngx.INFO, "client was denied with reason : " .. ngx.ctx.reason)
end

logger:log(ngx.INFO, "log phase ended")

}